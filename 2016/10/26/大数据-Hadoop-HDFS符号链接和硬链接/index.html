<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="æ•°å¤§æ‹›ç–¯">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->





<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>HDFSç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥ | æ•°å¤§æ‹›ç–¯</title>


    <link rel="alternate" href="/atom.xml" title="æ•°å¤§æ‹›ç–¯" type="application/atom+xml">


    <link rel="icon" href="img/avatar.jpg">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

</head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">ä½ ä½¿ç”¨çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œä¸ºäº†ä½ æ›´å¥½çš„é˜…è¯»ä½“éªŒï¼Œè¯·æ›´æ–°æµè§ˆå™¨çš„ç‰ˆæœ¬æˆ–è€…ä½¿ç”¨å…¶ä»–ç°ä»£æµè§ˆå™¨ï¼Œæ¯”å¦‚Chromeã€Firefoxã€Safariç­‰ã€‚</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1536170179765&amp;di=ab07d5f5a24a9d2bab9d1473a74e006c&amp;imgtype=0&amp;src=http%3A%2F%2Fpic.90sjimg.com%2Fback_pic%2F00%2F04%2F20%2F33%2F9e0ba3e5c577b49250f84a20a11f079c.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='XueMin Zhang'>
            <img src="/img/avatar.jpg" alt="logoå¤´åƒ" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippetä¸»é¢˜,ä»æœªå¦‚æ­¤ç®€å•æœ‰è¶£</h2>-->
            
                <h2> æ•°å¤§æ‹›ç–¯ </h2>
            
    	</div>
    </div>
</header>

    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">æ•°å¤§æ‹›ç–¯</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>é¦–é¡µ</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/ç¼–ç¨‹åŸºç¡€/"><i class="fa "></i>ç¼–ç¨‹åŸºç¡€</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/å¤§æ•°æ®/"><i class="fa "></i>å¤§æ•°æ®</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/æ•°æ®ç§‘å­¦"><i class="fa "></i>æ•°æ®ç§‘å­¦</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/å›¾å­˜å‚¨ã€è®¡ç®—"><i class="fa "></i>å›¾å­˜å‚¨ã€è®¡ç®—</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/å·¥ç¨‹ã€å·¥å…·"><i class="fa "></i>å·¥ç¨‹ã€å·¥å…·</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/"><i class="fa "></i>è¯»ä¹¦</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>æ—¶é—´è½´</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="HDFSç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥">
            
	            HDFSç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥
            
        </h1>
        <div class="post-meta">

    
    

    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/å¤§æ•°æ®">
            å¤§æ•°æ®
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/Hadoop" title='Hadoop'>
                        Hadoop
                    </a>
                
            
        </span>
    </span>
    


        <span>
         
         ğŸ•’ 2016å¹´10æœˆ26æ—¥
        </span>

       <span>
         <i class="fa fa-icon-user"></i>
          âœ ZhangXueMin
        </span>

    
        

        
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <p>åˆçœ‹è¿™ä¸ªæ ‡é¢˜ï¼Œå¯èƒ½å¾ˆå¤šäººä¼šå¿ƒç”Ÿç–‘é—®ï¼šç¬¦å·é“¾æ¥å’Œç¡¬é“¾æ¥æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè¿™äº›æ¦‚å¿µä¸æ˜¯åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹æ‰æœ‰çš„å˜›ï¼ŒHDFSç›®å‰ä¹Ÿæœ‰ï¼Ÿå½“ç„¶å¤§å®¶å¯èƒ½è¿˜ä¼šæœ‰å…¶ä»–ç–‘é—®ï¼Œæ²¡å…³ç³»ï¼Œåœ¨åé¢çš„å†…å®¹è®²è¿°ä¸­ç­”æ¡ˆä¼šä¸€ä¸€æ­æ™“ã€‚å½’çº³èµ·æ¥ä¸€å¥è¯ï¼šä¸ç®¡æ˜¯ç¬¦å·é“¾æ¥è¿˜æ˜¯ç¡¬é“¾æ¥ï¼Œå®ƒä»¬æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ç§å¿«æ·çš„é“¾æ¥æ–¹å¼ã€‚ç†Ÿæ‚‰Linuxç³»ç»Ÿçš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“åœ¨Linuxæ–‡ä»¶ç³»ç»Ÿä¸‹æœ‰ç¡¬é“¾æ¥å’Œè½¯é“¾æ¥çš„æ¦‚å¿µï¼Œè€ŒHDFSåŒæ ·ä½œä¸ºä¸€å¥—æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä¹Ÿèƒ½æ”¯æŒæ–‡ä»¶é“¾æ¥çš„å½¢å¼ã€‚æœ¬æ–‡æ‰€è®²è¿°çš„ä¸»é¢˜æ­£æ˜¯HDFSä¸‹çš„æ–‡ä»¶é“¾æ¥æ“ä½œã€‚</p>
<p>ç›¸å…³èƒŒæ™¯ï¼šLinuxè½¯é“¾æ¥å’Œç¡¬é“¾æ¥<br>åœ¨è®²è¿°HDFSä¸‹çš„æ–‡ä»¶é“¾æ¥å†…å®¹ä¹‹å‰ï¼Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹ç›¸å…³å†…å®¹ï¼šLinuxè½¯é“¾æ¥å’Œç¡¬é“¾æ¥ã€‚å› ä¸ºHDFSæ–‡ä»¶é“¾æ¥çš„åŸç†è®¾è®¡åŸºæœ¬ä¸æ­¤ç›¸ä¼¼ã€‚Linuxè½¯é“¾æ¥å’Œç¡¬é“¾æ¥åˆ†åˆ«ä»£è¡¨ç€2ç§æˆªç„¶ä¸åŒçš„è¿æ¥å½¢å¼ï¼Œå®ƒä»¬åœ¨ä½œç”¨ä¸Šä¹Ÿå­˜åœ¨éƒ¨åˆ†å¾®å¦™çš„å·®å¼‚ã€‚</p>
<p>è½¯é“¾æ¥<br>è½¯é“¾æ¥åˆè¢«ç§°ä¸ºç¬¦å·é“¾æ¥ï¼Œè‹±æ–‡åç§°soft linkæˆ–symbolic linkï¼ˆHDFSå†…é‡‡ç”¨çš„è½¯é“¾æ¥åç§°å°±æ˜¯symbolic linkï¼Œç®€ç§°symlinkï¼‰ã€‚å°±ä¸ªäººæ„Ÿè§‰è€Œè¨€ï¼Œè½¯é“¾æ¥åœ¨å®é™…å·¥ä½œä¸­ç”¨å¾—é¢‘ç‡ä¼šç•¥é«˜äºç¡¬é“¾æ¥ã€‚ä¸€å¥è¯ç®€å•åœ°æ¦‚æ‹¬è½¯é“¾æ¥çš„ä½œç”¨ï¼š</p>
<p>è½¯é“¾æ¥å…¶å®å°±æ˜¯æ–‡ä»¶çš„ä¸€ä¸ªå¿«æ·æ–¹å¼ï¼Œè½¯é“¾æ¥åˆ é™¤äº†ï¼Œå…¶æŒ‡å‘çš„çœŸå®æ–‡ä»¶å¹¶ä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<p>æ‰€ä»¥åœ¨å®é™…çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæŠŠä¾èµ–èµ„æºåŒ…çš„è·¯å¾„ç”¨è½¯é“¾æ¥çš„æ–¹å¼å¼•ç”¨ï¼Œè¿™æ ·çš„è¯èµ„æºåŒ…çš„è·¯å¾„å¯ä»¥ä¸€ç›´ä¿æŒä¸å˜ï¼Œè€Œå…¶æ‰€æŒ‡å‘çš„çœŸå®èµ„æºåŒ…å¯ä»¥æ ¹æ®ä½¿ç”¨åœºæ™¯è¿›è¡Œä»»æ„å˜åŒ–ã€‚</p>
<p>ç¡¬é“¾æ¥<br>ç¡¬é“¾æ¥ï¼Œè‹±æ–‡åç§°ä¸ºhard linkã€‚å®ƒçš„ä¸€ä¸ªä¸»è¦ç›®çš„åœ¨äºæ–‡ä»¶çš„å…±äº«ã€‚æ–‡ä»¶çš„ç¡¬é“¾æ¥åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œå®ƒå…·æœ‰å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š</p>
<p>ç¡¬é“¾æ¥ç›¸å½“äºæ–‡ä»¶çš„ä¸€ä¸ªåˆ«åã€‚å®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶inodeçš„å¼•ç”¨åœ°å€ï¼Œè€Œéè½¯é“¾æ¥ä¸­çš„æ–‡ä»¶è·¯å¾„æŒ‡å‘ã€‚æ‰€ä»¥å¯¹äºç¡¬é“¾æ¥ä¸­çš„æ–‡ä»¶åšä¿®æ”¹ä¼šå½±å“åˆ°å…¶æ‰€æŒ‡å‘çš„çœŸå®æ–‡ä»¶ï¼Œå½“å¯¹ç¡¬é“¾æ¥åšåˆ é™¤åŠ¨ä½œåï¼Œå¦‚æœå…¶æ‰€æŒ‡å‘çš„æ–‡ä»¶inodeå½“å‰æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨çš„è¯ï¼Œåˆ™åŸæ–‡ä»¶ä¼šè¢«åˆ é™¤ï¼Œå¦åˆ™åŸæ–‡ä»¶ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
<p>ä¸Šé¢çš„æ„æ€é€šä¿—åœ°è§£é‡Šå°±æ˜¯è¯´ï¼Œå½“çœŸå®æ–‡ä»¶æˆ–æ­¤æ–‡ä»¶çš„ç¡¬é“¾æ¥æœ‰ä¸€ä¸ªå­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå¯¹æ–‡ä»¶æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œæ–‡ä»¶ä¸ä¼šè¢«çœŸæ­£åˆ é™¤ã€‚å½“åªå‰©ä¸‹ä¸€ä¸ªæ–‡ä»¶inodeå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåˆ é™¤æ“ä½œæ‰èƒ½ç”Ÿæ•ˆã€‚</p>
<p>HDFSç¬¦å·é“¾æ¥ï¼ˆè½¯é“¾æ¥ï¼‰ä¸ç¡¬é“¾æ¥æ¦‚è¿°<br>äº†è§£å®ŒLinuxä¸‹çš„è½¯é“¾æ¥ä¸ç¡¬é“¾æ¥çš„æ¦‚å¿µåï¼Œæˆ‘ä»¬å°†è¿›å…¥æœ¬æ–‡çš„ä¸»é¢˜ï¼šHDFSä¸‹çš„ç¬¦å·é“¾æ¥ä¸ç¡¬é“¾æ¥ã€‚</p>
<p>Hadoopç¤¾åŒºåœ¨HDFS-245ï¼ˆCreate symbolic links in HDFSï¼‰ä¸­ä¼˜å…ˆå¯¹ç¬¦å·é“¾æ¥åŠŸèƒ½è¿›è¡Œäº†å®ç°ã€‚ç¬¦å·é“¾æ¥å¦å¤–ä¸€éƒ¨åˆ†çš„å·¥ä½œåœ¨HADOOP-6421ï¼ˆSymbolic linksï¼‰ä¸­ï¼Œæ­¤éƒ¨åˆ†æ˜¯HADOOP-COMMONæ¨¡å—ç›¸å…³çš„åº•å±‚ä»£ç æ”¹åŠ¨ã€‚åœ¨ç¡¬é“¾æ¥æ–¹é¢ï¼Œç¤¾åŒºç›®å‰æœ‰ç›¸å…³çš„JIRAï¼šHDFS-3370ï¼ˆHDFS hardlinkï¼‰ï¼Œä½†æ˜¯ç¤¾åŒºç›®å‰å¹¶æ²¡æœ‰åœ¨è·Ÿè¿›ï¼Œåªæœ‰åˆå§‹çš„è®¾è®¡æ–‡æ¡£ã€‚æ‰€ä»¥æœ¬æ–‡å‡†å¤‡è®²è¿°çš„HDFSç¡¬é“¾æ¥å°†ä¼šæ˜¯ä¸€ä¸ªè®¾è®¡æ¨¡å‹ï¼Œå¹¶æœªçœŸæ­£å®ç°ï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚</p>
<p>é‰´äºç›®å‰HDFSçš„ç¡¬é“¾æ¥åŠŸèƒ½å¹¶æœªçœŸæ­£å®ç°ï¼Œæ‰€ä»¥æœ¬æ–‡çš„ä¸»è®²å†…å®¹è¿˜æ˜¯ç¬¦å·é“¾æ¥çš„åŠŸèƒ½ï¼Œç¡¬é“¾æ¥åŠŸèƒ½å°†ç»™å‡ºå¤§è‡´è®¾è®¡æ¨¡å‹ã€‚</p>
<p>HDFSç¬¦å·é“¾æ¥ï¼ˆè½¯é“¾æ¥ï¼‰<br>HDFSç¬¦å·é“¾æ¥ï¼Œåœ¨HDFSä¸­ç§°ä¹‹ä¸ºsymbolic linkï¼Œåœ¨ä¸‹æ–‡çš„è®²è¿°ä¸­æ­¤åç§°éƒ½å°†ä¼šç®€ç§°ä¸ºsymlinkã€‚ä¸Linuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„è½¯é“¾æ¥æ¦‚å¿µä¸€æ ·ï¼ŒHDFSç¬¦å·é“¾æ¥ä¹Ÿæ˜¯ç›¸å½“äºç»™ç›®æ ‡æ–‡ä»¶æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰è·¯å¾„ï¼Œè¿™ä¸ªè‡ªå®šä¹‰è·¯å¾„å®è´¨æŒ‡å‘ç›®æ ‡æ–‡ä»¶ã€‚æ‰€ä»¥åœ¨è¿™é‡ŒHDFSç¬¦å·é“¾æ¥ä¸­åšçš„æœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯è·¯å¾„çš„è§£æã€‚è€Œä¸”è¿™ä¸ªè§£æè¿˜æœ‰å¯èƒ½æ˜¯åµŒå¥—çš„ï¼Œç¬¦å·é“¾æ¥ä¸­æŒ‡å‘çš„æ˜¯å¦å¤–ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚ä¸‹é¢æ¥å­¦ä¹ HDFSç¬¦å·é“¾æ¥çš„ä¸»è¦åŸç†å®ç°ã€‚</p>
<p>HDFSç¬¦å·é“¾æ¥åŸç†<br>HDFSç¬¦å·é“¾æ¥åŠŸèƒ½çš„å®ç°ä¸»è¦åˆ†ä¸º2ä¸ªéƒ¨åˆ†ï¼šä¸€ä¸ªæ˜¯å¯¹ç°æœ‰æ–‡ä»¶ç¬¦å·é“¾æ¥çš„æ·»åŠ ï¼Œå¦å¤–ä¸€ä¸ªåˆ™æ˜¯ç¬¦å·é“¾æ¥çš„è§£æè¿‡ç¨‹ã€‚</p>
<p>å¯¹ç°æœ‰æ–‡ä»¶ç¬¦å·é“¾æ¥çš„æ·»åŠ åœ¨HDFSä¸­çš„å®ç°å°±æ˜¯æ·»åŠ ä¸€ä¸ªæ–°çš„INodeå¯¹è±¡åœ¨NameNodeä¸­ï¼Œåªæ˜¯è¿™ä¸ªINodeå¯¹è±¡æ˜¯Symlinkç±»å‹çš„ï¼Œå«åšINodeSymlinkã€‚æ­¤å¯¹è±¡å†…éƒ¨ä¼šåŒ…å«ä¸€ä¸ªå®é™…æŒ‡å‘çš„targetåœ°å€ã€‚</p>
<p>è€Œç¬¦å·é“¾æ¥çš„è§£æè¿‡ç¨‹åˆ™ä¼šç•¥å¾®å¤æ‚ä¸€äº›ï¼ŒHDFSå¹¶ä¸æ˜¯ç›´æ¥åœ¨NameNodeæœ€ç»ˆå¤„ç†æ–¹æ³•çš„åœ°æ–¹åšè§£æçš„ï¼Œè€Œæ˜¯åœ¨å‰é¢ä¸€å±‚FileContextç±»ä¸Šåšè§£æçš„ï¼Œç„¶åå°†è§£æå¥½åçš„è·¯å¾„å†ä¼ åˆ°HDFSä¸­åšå¤„ç†ã€‚æ¢å¥è¯è¯´ï¼Œå®¢æˆ·ç«¯éœ€è¦é€šè¿‡FileContextä¸Šä¸‹æ–‡å¯¹è±¡æ¥æ“ä½œç¬¦å·é“¾æ¥ç›¸å…³çš„æ“ä½œï¼Œå¦‚æœç›´æ¥ç”¨FileSystemçš„APIæ¥æ“ä½œçš„è¯ï¼Œä¼šæŠ›å‡ºè§£æå¼‚å¸¸çš„é”™è¯¯ã€‚</p>
<p>HDFSç¬¦å·é“¾æ¥æ ¸å¿ƒä»£ç å®ç°<br>æ­¤éƒ¨åˆ†æˆ‘ä»¬å°†é€šè¿‡éƒ¨åˆ†ä»£ç çš„è·Ÿè¸ªæ¥å­¦ä¹ HDFSç¬¦å·é“¾æ¥çš„å®ç°è¿‡ç¨‹ã€‚</p>
<p>åŒæ ·é¦–å…ˆæ˜¯åˆ›å»ºç¬¦å·é“¾æ¥çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°æœ€ç»ˆçš„æœåŠ¡ç«¯å¤„ç†æ–¹æ³•ï¼ŒFSNamesystemçš„createSymlinkæ–¹æ³•ã€‚</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>*// ä¸ºç›®æ ‡æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç¬¦å·é“¾æ¥<br>void createSymlink(String target, String link,<br>    PermissionStatus dirPerms, boolean createParent, boolean logRetryCache)<br>    throws IOException {<br>  if (!FileSystem.areSymlinksEnabled()) {<br>    throw new UnsupportedOperationException(â€œSymlinks not supportedâ€);<br>  }<br>  HdfsFileStatus auditStat = null;<br>  writeLock();<br>  try {<br>    checkOperation(OperationCategory.WRITE);<br>    checkNameNodeSafeMode(â€œCannot create symlink â€œ + link);<br>    // æ­¤å¤„è¿›å…¥åˆ›å»ºè½¯é“¾æ¥å®é™…æ“ä½œ<br>    auditStat = FSDirSymlinkOp.createSymlinkInt(this, target, link, dirPerms,<br>                                                createParent, logRetryCache);<br>    â€¦<br>æˆ‘ä»¬ç»§ç»­è¿›å…¥FSDirSymlinkOpçš„createSymlinkIntæ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>static HdfsFileStatus createSymlinkInt(<br>    FSNamesystem fsn, String target, final String linkArg,<br>    PermissionStatus dirPerms, boolean createParent, boolean logRetryCache)<br>    throws IOException {<br>  FSDirectory fsd = fsn.getFSDirectory();<br>  String link = linkArg;<br>  // æ£€éªŒç¬¦å·é“¾æ¥çš„åç§°<br>  if (!DFSUtil.isValidName(link)) {<br>    throw new InvalidPathException(â€œInvalid link name: â€œ + link);<br>  }<br>  if (FSDirectory.isReservedName(target) || target.isEmpty()<br>      || FSDirectory.isExactReservedName(target)) {<br>    throw new InvalidPathException(â€œInvalid target name: â€œ + target);<br>  }</p>
<p>  if (NameNode.stateChangeLog.isDebugEnabled()) {<br>    NameNode.stateChangeLog.debug(â€œDIR* NameSystem.createSymlink: target=â€</p>
<pre><code>+ target + &quot; link=&quot; + link);
</code></pre><p>  }</p>
<p>  FSPermissionChecker pc = fsn.getPermissionChecker();<br>  INodesInPath iip;<br>  fsd.writeLock();<br>  try {<br>    // è§£æå¾—åˆ°ç¬¦å·é“¾æ¥çš„è·¯å¾„å¯¹è±¡<br>    iip = fsd.resolvePathForWrite(pc, link, false);<br>    link = iip.getPath();<br>    â€¦</p>
<pre><code>// å°†æ­¤ç¬¦å·é“¾æ¥å¯¹è±¡åŠ å…¥åˆ°NameNodeå…ƒæ•°æ®ä¸­
addSymlink(fsd, link, iip, target, dirPerms, createParent, logRetryCache);
...
</code></pre><p>æˆ‘ä»¬ç»§ç»­è¿›å…¥addSymlinkæ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>private static INodeSymlink addSymlink(FSDirectory fsd, String path,<br>    INodesInPath iip, String target, PermissionStatus dirPerms,<br>    boolean createParent, boolean logRetryCache) throws IOException {<br>  final long mtime = now();<br>  final INodesInPath parent;<br>  // è·å–ç›®æ ‡ç¬¦å·é“¾æ¥çš„çˆ¶äº²å¯¹è±¡<br>  if (createParent) {<br>    // å¦‚æœéœ€è¦åˆ›å»ºçˆ¶äº²å¯¹è±¡ï¼Œåˆ™è¿›è¡Œåˆ›å»ºçˆ¶ç›®å½•æ“ä½œæ–¹æ³•<br>    parent = FSDirMkdirOp.createAncestorDirectories(fsd, iip, dirPerms);<br>    if (parent == null) {<br>      return null;<br>    }<br>  } else {<br>    parent = iip.getParentINodesInPath();<br>  }<br>  final String userName = dirPerms.getUserName();<br>  long id = fsd.allocateNewInodeId();<br>  PermissionStatus perm = new PermissionStatus(<br>      userName, null, FsPermission.getDefault());<br>  // åŠ å…¥ç¬¦å·é“¾æ¥ç±»å‹çš„INodeå¯¹è±¡åˆ°çˆ¶å¯¹è±¡ä¸­<br>  INodeSymlink newNode = unprotectedAddSymlink(fsd, parent,<br>      iip.getLastLocalName(), id, target, mtime, mtime, perm);<br>  â€¦<br>æœ€åè°ƒç”¨åˆ°åŠ å…¥NameNodeå‘½åç©ºé—´æ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>static INodeSymlink unprotectedAddSymlink(FSDirectory fsd, INodesInPath iip,<br>    byte[] localName, long id, String target, long mtime, long atime,<br>    PermissionStatus perm)<br>    throws UnresolvedLinkException, QuotaExceededException {<br>  assert fsd.hasWriteLock();<br>  // æ–°å»ºç¬¦å·é“¾æ¥ç±»å‹çš„INodeå¯¹è±¡<br>  final INodeSymlink symlink = new INodeSymlink(id, null, perm, mtime, atime,<br>      target);<br>  symlink.setLocalName(localName);<br>  // å°†ç¬¦å·é“¾æ¥å¯¹è±¡åŠ å…¥åˆ°æœ€ç»ˆè·¯å¾„å¯¹åº”çš„ä¸Šä¸€çº§çˆ¶ç›®å½•ä¸‹<br>  return fsd.addINode(iip, symlink, perm.getPermission()) != null ?<br>      symlink : null;<br>}<br>è‡³æ­¤ï¼Œæ·»åŠ è½¯é“¾æ¥æ“ä½œæ­£å¼å®Œæ¯•ï¼Œä¸æ™®é€šHDFSæ–‡ä»¶INodeå¯¹è±¡çš„æ·»åŠ è¿‡ç¨‹ç±»ä¼¼ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å¦å¤–ä¸€ä¸ªéƒ¨åˆ†çš„å†…å®¹ï¼šHDFSç¬¦å·é“¾æ¥çš„è·¯å¾„è§£æè¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯æœ¬æ–‡çš„ä¸€ä¸ªé‡ç‚¹ã€‚åœ¨æ²¡æœ‰å­¦ä¹ HDFSç¬¦å·é“¾æ¥æºä»£ç ä¹‹å‰ï¼Œæœ¬äººä¸€ç›´ä»¥ä¸ºHDFSæŠŠç¬¦å·é“¾æ¥çš„è§£æè¿‡ç¨‹æ”¾åœ¨äº†NameNodeçš„å¤„ç†æ–¹æ³•ä¸­ï¼Œä½†æœ€ç»ˆç»“æœè¡¨æ˜ï¼Œäº‹å®å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬ç›´æ¥ä»¥HDFSæ–‡ä»¶çš„ç¬¦å·é“¾æ¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œç©¶ç«Ÿä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬ä»¥setReplicationè®¾ç½®å‰¯æœ¬æ•°æ“ä½œä¸ºä¾‹ã€‚</p>
<p>é¦–å…ˆé€šè¿‡DFSClientç«¯æ‰§è¡ŒsetReplicationæ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>*// ä¸ºæŒ‡å®šçš„æ–‡ä»¶è¿›è¡Œå‰¯æœ¬æ•°çš„è®¾ç½®ï¼Œå‡è®¾æˆ‘ä»¬è¿™é‡Œä¼ å…¥çš„srcè·¯å¾„æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œè€ŒéçœŸå®æ–‡ä»¶åœ°å€<br>public boolean setReplication(String src, short replication)<br>    throws IOException {<br>  checkOpen();<br>  try (TraceScope ignored = newPathTraceScope(â€œsetReplicationâ€, src)) {<br>    // å‘æœåŠ¡ç«¯å‘èµ·è®¾ç½®å‰¯æœ¬æ•°æ“ä½œè¯·æ±‚<br>    return namenode.setReplication(src, replication);<br>  } catch (RemoteException re) {<br>    â€¦<br>  }<br>}<br>æˆ‘ä»¬ç›´æ¥è¿›å…¥FSNamesystemçš„ç›¸åº”å¤„ç†æ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>boolean setReplication(final String src, final short replication)<br>    throws IOException {<br>  boolean success = false;<br>  checkOperation(OperationCategory.WRITE);<br>  writeLock();<br>  try {<br>    checkOperation(OperationCategory.WRITE);<br>    checkNameNodeSafeMode(â€œCannot set replication for â€œ + src);<br>    // è°ƒç”¨çœŸæ­£è®¾ç½®å‰¯æœ¬æ•°æ–¹æ³•<br>    success = FSDirAttrOp.setReplication(dir, blockManager, src, replication);<br>  } catch (AccessControlException e) {<br>    logAuditEvent(false, â€œsetReplicationâ€, src);<br>    throw e;<br>  } finally {<br>    writeUnlock();<br>  }<br>  â€¦<br>  return success;<br>}<br>è¿™é‡Œè¿›å…¥FSDirAttrOpçš„setReplicationæ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>static boolean setReplication(<br>    FSDirectory fsd, BlockManager bm, String src, final short replication)<br>    throws IOException {<br>  bm.verifyReplication(src, replication, null);<br>  final boolean isFile;<br>  FSPermissionChecker pc = fsd.getPermissionChecker();<br>  fsd.writeLock();<br>  try {<br>    // è§£ææ­¤è·¯å¾„å¾—åˆ°INodeè·¯å¾„å¯¹è±¡<br>    final INodesInPath iip = fsd.resolvePathForWrite(pc, src);<br>    if (fsd.isPermissionEnabled()) {<br>      fsd.checkPathAccess(pc, iip, FsAction.WRITE);<br>    }<br>    // å¯¹æ­¤è·¯å¾„è¿›è¡Œå‰¯æœ¬çš„è®¾ç½®<br>    final BlockInfo[] blocks = unprotectedSetReplication(fsd, iip,<br>                                                         replication);<br>    â€¦<br>è‡³å°‘ä»ç›®å‰æ¥çœ‹ï¼Œæˆ‘ä»¬è¿˜æ²¡çœ‹åˆ°è§£æç¬¦å·é“¾æ¥çš„æ“ä½œï¼Œæˆ‘ä»¬ç»§ç»­è¿›å…¥è®¾ç½®å‰¯æœ¬çš„è¿›ä¸€æ­¥æ“ä½œï¼šunprotectedSetReplicationæ–¹æ³•ã€‚</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>static BlockInfo[] unprotectedSetReplication(<br>    FSDirectory fsd, INodesInPath iip, short replication)<br>    throws QuotaExceededException, UnresolvedLinkException,<br>    SnapshotAccessControlException, UnsupportedActionException {<br>  assert fsd.hasWriteLock();</p>
<p>  final BlockManager bm = fsd.getBlockManager();<br>  // è·å–è·¯å¾„å¯¹è±¡çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆéœ€è¦è®¾ç½®å‰¯æœ¬çš„æ–‡ä»¶INodeå¯¹è±¡<br>  final INode inode = iip.getLastINode();<br>  if (inode == null || !inode.isFile() || inode.asFile().isStriped()) {<br>    // TODO we do not support replication on stripe layout files yet<br>    return null;<br>  }<br>  // å¾—åˆ°æ­¤INodeFileå¯¹è±¡<br>  INodeFile file = inode.asFile();<br>  // Make sure the directory has sufficient quotas<br>  short oldBR = file.getPreferredBlockReplication();</p>
<p>  long size = file.computeFileSize(true, true);<br>  // Ensure the quota does not exceed<br>  if (oldBR &lt; replication) {<br>    fsd.updateCount(iip, 0L, size, oldBR, replication, true);<br>  }<br>  // å¯¹è±¡æ–‡ä»¶å¯¹è±¡è¿›è¡Œå‰¯æœ¬æ•°çš„è®¾ç½®<br>  file.setFileReplication(replication, iip.getLatestSnapshotId());<br>  short targetReplication = (short) Math.max(<br>      replication, file.getPreferredBlockReplication());</p>
<p>  â€¦<br>  return file.getBlocks();<br>}<br>åœ¨æ­¤æ–¹æ³•ä¸­ï¼ŒHDFSç›´æ¥ä»è·¯å¾„å¯¹è±¡ä¸­å–å‡ºæ–‡ä»¶INodeå¯¹è±¡ï¼Œç„¶åå¯¹å…¶è¿›è¡Œå‰¯æœ¬æ•°çš„è®¾ç½®ï¼Œä»ä¸­å¹¶æ²¡æœ‰å¯¹ç¬¦å·é“¾æ¥è¿›è¡Œè§£æçš„æ“ä½œã€‚æˆ‘ä»¬é‡æ–°æŠŠç›®å…‰å›åˆ°ä¹‹å‰FSDirAttrOpçš„setReplicationæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­çš„fsd.resolvePathForWriteæ“ä½œæ˜¯å¦ä¼šæœ‰è¿™æ ·çš„è§£æåŠ¨ä½œå‘¢ï¼Œä»æ–¹æ³•åä¸Šçœ‹ä¹Ÿç¡®å®åŒ…å«äº†è§£æçš„å•è¯ã€‚è¿™é‡Œè¿›å…¥FSDirectoryçš„resolvePathForWriteæ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>INodesInPath resolvePathForWrite(FSPermissionChecker pc, String src)<br>    throws UnresolvedLinkException, FileNotFoundException,<br>    AccessControlException {<br>  // æ­¤å¤„è°ƒç”¨åŒåæ–¹æ³•ï¼Œè¿™é‡Œçš„ç¬¬ä¸‰ä¸ªå¸ƒå°”å‚æ•°ä»£è¡¨è§£æåˆ°ç¬¦å·é“¾æ¥çš„INodeå¯¹è±¡æ—¶æ˜¯å¦æŠ›å‡ºå¼‚å¸¸<br>  return resolvePathForWrite(pc, src, true);<br>}<br>æ­¤æ–¹æ³•ä¸­é—´ä¼šè°ƒç”¨å±‚å±‚æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨INodesInPathç±»å†…éƒ¨çš„resolveæ–¹æ³•ã€‚æ­¤æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>static INodesInPath resolve(final INodeDirectory startingDir,<br>    final byte[][] components, final boolean isRaw,<br>    final boolean resolveLink) throws UnresolvedLinkException {<br>  Preconditions.checkArgument(startingDir.compareTo(components[0]) == 0);</p>
<p>  INode curNode = startingDir;<br>  int count = 0;<br>  int inodeNum = 0;<br>  INode[] inodes = new INode[components.length];<br>  boolean isSnapshot = false;<br>  int snapshotId = CURRENT_STATE_ID;</p>
<p>  while (count &lt; components.length &amp;&amp; curNode != null) {<br>    final boolean lastComp = (count == components.length - 1);<br>    inodes[inodeNum++] = curNode;<br>    final boolean isRef = curNode.isReference();<br>    final boolean isDir = curNode.isDirectory();<br>    final INodeDirectory dir = isDir? curNode.asDirectory(): null;<br>    if (!isRef &amp;&amp; isDir &amp;&amp; dir.isWithSnapshot()) {<br>      â€¦<br>    } else if (isRef &amp;&amp; isDir &amp;&amp; !lastComp) {<br>      â€¦<br>    }<br>    // å¦‚æœå½“å‰INodeæ˜¯ç¬¦å·é“¾æ¥ç±»å‹å¹¶ä¸”å½“å‰éœ€è¦æŠ›å‡ºç¬¦å·é“¾æ¥å¼‚å¸¸æˆ–å½“å‰ä¸æ˜¯æœ€åä¸€ä¸ªINodeå¯¹è±¡æ—¶ï¼Œ<br>    // éƒ½æŠ›å‡ºå¼‚å¸¸<br>    if (curNode.isSymlink() &amp;&amp; (!lastComp || resolveLink)) {<br>      final String path = constructPath(components, 0, components.length);<br>      final String preceding = constructPath(components, 0, count);<br>      final String remainder =<br>        constructPath(components, count + 1, components.length);<br>      // è·å–ç¬¦å·é“¾æ¥åœ°å€<br>      final String link = DFSUtil.bytes2String(components[count]);<br>      // è·å–ç¬¦å·é“¾æ¥çœŸå®æŒ‡å‘åœ°å€<br>      final String target = curNode.asSymlink().getSymlinkString();<br>      if (LOG.isDebugEnabled()) {<br>        LOG.debug(â€œUnresolvedPathException â€œ +<br>          â€œ path: â€œ + path + â€œ preceding: â€œ + preceding +<br>          â€œ count: â€œ + count + â€œ link: â€œ + link + â€œ target: â€œ + target +<br>          â€œ remainder: â€œ + remainder);<br>      }<br>      // æŠ›å‡ºæ— æ³•è§£æå¼‚å¸¸<br>      throw new UnresolvedPathException(path, preceding, remainder, target);<br>    }<br>    â€¦<br>  return new INodesInPath(inodes, components, isRaw, isSnapshot, snapshotId);<br>}<br>ä»ä¸Šé¢çš„æ“ä½œæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸¤ä¸ªç»“è®ºï¼š</p>
<p>ç¬¬ä¸€ç‚¹ï¼ŒHDFSç¬¦å·é“¾æ¥çš„è§£æé€»è¾‘å¹¶ä¸æ˜¯å®ç°åœ¨NameNodeæœåŠ¡ç«¯çš„å¤„ç†ä»£ç ä¸­ã€‚ ç¬¬äºŒç‚¹ï¼ŒNameNodeæœåŠ¡ç«¯ä¸­è§£æç¬¦å·é“¾æ¥çš„ç›®çš„åœ¨äºå¸®åŠ©æŠ›å‡ºè§£æå¼‚å¸¸ä¿¡æ¯ï¼Œä»¥æ­¤å‘Šè¯‰ç”¨æˆ·å½“å‰å¤„ç†çš„è·¯å¾„æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥åœ°å€ã€‚<br>é‚£ä¹ˆè¿™éƒ¨åˆ†çš„è§£æé€»è¾‘åˆ°åº•å‘ç”Ÿåœ¨äº†ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿè¿™ä¸ªç­”æ¡ˆæˆ‘ä»¬å¯ä»¥ä»ç¬¦å·é“¾æ¥çš„å•å…ƒæµ‹è¯•å®ä¾‹ä¸­è¿›è¡Œå¯»æ‰¾ï¼ŒèŒƒä¾‹ä»£ç å¦‚ä¸‹ï¼ˆåŒæ ·ä»¥è®¾ç½®å‰¯æœ¬æ•°æ“ä½œä¸ºä¾‹ï¼‰ï¼š</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>@Test<br> /*<em> setReplication affects the target not the link </em>/<br> public void testSetReplication() throws IOException {<br>   Path file = new Path(testBaseDir1(), â€œfileâ€);<br>   Path link = new Path(testBaseDir1(), â€œlinkToFileâ€);<br>   createAndWriteFile(file);<br>   fc.createSymlink(file, link, false);<br>   // æ­¤å¤„é€šè¿‡fcå¯¹è±¡è¿›è¡Œè®¾ç½®ï¼ŒfcæŒ‡çš„æ˜¯æ–‡ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡<br>   fc.setReplication(link, (short)2);<br>   assertEquals(0, fc.getFileLinkStatus(link).getReplication());<br>   assertEquals(2, fc.getFileStatus(link).getReplication());<br>   assertEquals(2, fc.getFileStatus(file).getReplication());<br>}<br>ä¸Šé¢ç¬¦å·é“¾æ¥çš„è®¾ç½®å‰¯æœ¬æ“ä½œæ˜¯é€šè¿‡fcå¯¹è±¡è¿›è¡Œçš„ï¼Œfcå¯¹è±¡çš„æ„æ€æ˜¯æ–‡ä»¶ä¸Šä¸‹æ–‡ï¼Œæ­¤å¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œå¦‚ä¸‹ï¼š</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>@BeforeClass<br>public static void testSetUp() throws Exception {<br>  Configuration conf = new HdfsConfiguration();<br>  conf.setBoolean(DFSConfigKeys.DFS_PERMISSIONS_ENABLED_KEY, true);<br>  conf.set(FsPermission.UMASK_LABEL, â€œ000â€);<br>  cluster = new MiniDFSCluster(conf, 1, true, null);<br>  // æµ‹è¯•å®ä¾‹åˆå§‹åŒ–æ“ä½œä¸­ï¼Œå¾—åˆ°æ–‡ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡<br>  fc = FileContext.getFileContext(cluster.getURI());<br>}<br>è‡³æ­¤ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥ç”¨FileSystemå¯¹è±¡è¿›è¡Œç¬¦å·é“¾æ¥ç›¸å…³æ“ä½œæ‰§è¡Œçš„åŸå› ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥èŠèŠFileContextåˆ°åº•æ˜¯å¦‚ä½•å¸®åŠ©ç”¨æˆ·å®Œæˆç¬¦å·é“¾æ¥çš„è§£æè¿‡ç¨‹çš„ã€‚æ¯”å¦‚è¯´ï¼Œç°åœ¨æˆ‘å·²ç»åˆå§‹åŒ–å¥½äº†ä¸€ä¸ªFileContextå¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†setReplicationæ“ä½œï¼Œæ¥ç€ä¼šè§¦å‘åˆ°ä¸‹é¢çš„æ–¹æ³•ï¼Œ</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>public boolean setReplication(final Path f, final short replication)<br>    throws AccessControlException, FileNotFoundException,<br>    IOException {<br>  final Path absF = fixRelativePart(f);<br>  // è°ƒç”¨è§£æå™¨å¯¹è±¡è¿›è¡Œè§£æ<br>  return new FSLinkResolver<boolean>() {<br>    @Override<br>    public Boolean next(final AbstractFileSystem fs, final Path p)<br>      throws IOException, UnresolvedLinkException {<br>      // nextæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œpå·²ç»ä»£è¡¨äº†ç›®æ ‡çœŸå®æ–‡ä»¶åœ°å€<br>      return fs.setReplication(p, replication);<br>    }<br>  }.resolve(this, absF);<br>}</boolean><br>æ‰€ä»¥ä»¥ä¸Šçš„å®ç°å…³é”®ç‚¹åœ¨äºFSLinkResolverçš„è§£æè¿‡ç¨‹ã€‚æˆ‘ä»¬è¿›å…¥æ­¤ç±»ï¼Œè§£æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>?<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>public T resolve(final FileContext fc, final Path path) throws IOException {<br>  int count = 0;<br>  T in = null;<br>  Path p = path;<br>  // è·å–åˆå§‹æ–‡ä»¶ç³»ç»Ÿ<br>  AbstractFileSystem fs = fc.getFSofPath(p);</p>
<p>  // è¿›è¡Œå¾ªç¯è§£æï¼Œç›´åˆ°æ‰€æœ‰çš„ç¬¦å·é“¾æ¥åœ°å€éƒ½è¢«è§£ææˆåŠŸ<br>  for (boolean isLink = true; isLink;) {<br>    try {<br>      // å¦‚æœå½“å‰çš„è·¯å¾„è§£ææˆåŠŸï¼Œåˆ™æ›´æ–°æ ‡è®°ä¸ºfalse,è·³å‡ºå¾ªç¯ï¼Œä»£è¡¨å½“å‰è·¯å¾„å·²è§£ææˆåŠŸ<br>      in = next(fs, p);<br>      isLink = false;<br>    } catch (UnresolvedLinkException e) {<br>      â€¦<br>      // å¦åˆ™å‡ºç°ç¬¦å·é“¾æ¥æ—¶ï¼Œè§£æå½“å‰ç¬¬ä¸€å±‚ç¬¦å·é“¾æ¥åœ°å€ï¼Œfs.getLinkTarget(p)ä¼šè·å–å½“å‰ç¬¦å·é“¾æ¥åœ°å€æ‰€æŒ‡å‘çš„çœŸå®åœ°å€<br>      p = qualifySymlinkTarget(fs.getUri(), p, fs.getLinkTarget(p));<br>      fs = fc.getFSofPath(p);<br>      // ç„¶åç”¨æ–°çš„è·¯å¾„å’Œæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡è¿›è¡Œä¸‹ä¸€æ¬¡çš„æ“ä½œæ‰§è¡Œ<br>    }<br>  }<br>  return in;<br>}<br>fs.getLinkTarget(p)æ“ä½œæ–¹æ³•çš„å®ç°ï¼Œå¤§å®¶å¯ä»¥ä»DistributedFileSystemä¸­æŸ¥çœ‹å…¶å…·ä½“å®ç°ã€‚</p>
<p>æ‰€ä»¥ï¼ŒHDFSç¬¦å·é“¾æ¥çš„æ€»è¿‡ç¨‹è°ƒç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p>å›¾ 1-1 HDFSç¬¦å·é“¾æ¥è§£æè¿‡ç¨‹</p>
<p>HDFSç¡¬é“¾æ¥çš„åŸå‹è®¾è®¡<br>é‰´äºå‰é¢èŠ±äº†å¤§é‡çš„ç¯‡å¹…ä»‹ç»äº†HDFSç¬¦å·é“¾æ¥ï¼ˆè½¯é“¾æ¥ï¼‰çš„å†…å®¹ï¼Œæœ€åç®€å•ä»‹ç»ä»‹ç»HDFSç¡¬é“¾æ¥çš„å†…å®¹ã€‚å› ä¸ºæ­¤åŠŸèƒ½ç›®å‰åœ¨HDFSä¸­å¹¶æœªå®ç°ï¼Œåªæœ‰åŸå‹è®¾è®¡ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°†åªä¼šä»‹ç»ç¤¾åŒºä¸Šå¯¹äºæ­¤åŠŸèƒ½çš„ä¸€ä¸ªè®¾è®¡ã€‚</p>
<p>HDFSç¡¬é“¾æ¥çš„ä¸€ä¸ªæ ¸å¿ƒä½¿ç”¨ç‚¹åœ¨äºå®ƒå¯ä»¥åœ¨æ— éœ€æ‹·è´çœŸå®æ•°æ®çš„æƒ…å†µä¸‹ï¼Œå®ç°æ•°æ®çš„å…±äº«ã€‚ä¸ºäº†å®ç°è¿™æ ·çš„åŠŸèƒ½ï¼Œåœ¨HDFS-3370ä¸­çš„è®¾è®¡æ–‡æ¡£ä¸­ï¼Œè®¾è®¡è€…å¼•å…¥äº†INodeHardLinkFileå¯¹è±¡æ¥ä»£è¡¨å½“å‰çš„ä¸€ä¸ªç¡¬é“¾æ¥ã€‚è¿™äº›å¯¹è±¡å…±äº«HardLinkFileInfoå¯¹è±¡ã€‚åœ¨HardLinkFileInfoå¯¹è±¡ä¸­ï¼Œä¼šä¿æŒæœ‰å½“å‰çš„å¼•ç”¨è®¡æ•°å€¼ï¼Œè¡¨ç¤ºå½“å‰å¼•ç”¨æ­¤æ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°ï¼Œä¸Linuxæ“ä½œç³»ç»Ÿä¸­çš„ç¡¬é“¾æ¥ç±»ä¼¼ã€‚</p>
<p>ä¸‹é¢é€šè¿‡å›¾å½¢å±•ç¤ºçš„æ–¹å¼å¤§è‡´ä»‹ç»ä¸€ä¸‹HDFSç¡¬é“¾æ¥çš„åŸå‹è®¾è®¡ï¼š</p>
<p>é¦–å…ˆï¼Œå‡è®¾å½“å‰å­˜åœ¨ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡ä»¶File1ï¼Œå¦‚å›¾1-2ã€‚</p>
<p>å›¾ 1-2 HDFSåˆå§‹æ–‡ä»¶<br>æ­¤æ—¶å¯¹æ–‡ä»¶File1åˆ›å»ºä¸€ä¸ªç¡¬é“¾æ¥ï¼ŒåŒæ—¶åç§°ä¹Ÿä¸ºFile1ä¸å˜ï¼ŒFile1çš„INodeFileå¯¹è±¡å°†ä¼šè½¬åŒ–ä¸ºINodeHardLinkFileå¯¹è±¡ï¼ŒåŒæ—¶å¼•ç”¨è®¡æ•°ä¸º1ï¼Œæ­¤è¿‡ç¨‹è§å›¾1-3ã€‚</p>
<p>å›¾ 1-3 HDFSç¡¬é“¾æ¥çš„åˆ›å»º<br>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¦‚æœè¿˜è¦å¯¹æ­¤æ–‡ä»¶è¿›è¡Œç¡¬é“¾æ¥çš„åˆ›å»ºï¼Œå³ä¸ºINodeHardLinkFileçš„å†æ¬¡åˆ›å»ºï¼Œä½†æ˜¯å¼•ç”¨çš„HarLinkFileInfoè¿˜æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ŒHarLinkFileInfoå¼•ç”¨è®¡æ•°æ­¤æ—¶é€’å¢ 2ï¼Œæ­¤è¿‡ç¨‹è§å›¾1-4ã€‚</p>
<p>å›¾ 1-4 HDFSç¡¬é“¾æ¥çš„å†åˆ›å»º<br>è¿™ä¸ªäºLinuxç¡¬é“¾æ¥ä¸­çš„æ–‡ä»¶inodeå¼•ç”¨åŸç†æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚å½“ä¸ªåˆ«æ–‡ä»¶ç¡¬é“¾æ¥å¯¹è±¡çš„åˆ é™¤å°†ä¸ä¼šåˆ é™¤å…¶çœŸå®çš„æ•°æ®ï¼Œé™¤éç¡¬é“¾æ¥æ–‡ä»¶å½“å‰æ²¡æœ‰å…¶ä»–çš„å¼•ç”¨å¯¹è±¡äº†ã€‚</p>
<p>æ­¤è®¾è®¡æ–‡æ¡£çš„ä½œè€…æ˜¯æ¥è‡ªäºFacebookçš„æŸä½å·¥ç¨‹å¸ˆï¼Œæœ¬äººä¼°æµ‹æ­¤åŠŸèƒ½åœ¨Facebookå†…éƒ¨å·²ç»æ—©å·²å®ç°ï¼ŒHDFSç¡¬é“¾æ¥æ›´å¤šè®¾è®¡ç»†èŠ‚ï¼Œå¯ä»¥é˜…è¯»å‚è€ƒèµ„æ–™ä¸­çš„é“¾æ¥åœ°å€ã€‚</p>
<p>æ¥æºï¼š<a href="https://www.2cto.com/kf/201610/556336.html" target="_blank" rel="noopener">https://www.2cto.com/kf/201610/556336.html</a></p>

    </div>

    <div class="post-footer">
        <div>
            
                å£°æ˜ï¼šæ¬¢è¿è½¬è½½ã€é‡æ–°å‘å¸ƒã€‚å¦‚ç”¨äºå•†ä¸šç›®çš„ï¼Œè¯·<a href="mailto:xuemin.zhang@foxmail.com" target="_blank">è”ç³»ä½œè€…</a>è·å¾—æˆæƒã€‚éå•†ä¸šç›®çš„ï¼Œè¯·åŠ¡å¿…ä¿ç•™æ–‡ç« ä½œè€…ç½²å(<a href="https://zhangxuemin.cn" target="_blank">å¼ å­¦æ•</a>)åŠé“¾æ¥(https://zhangxuemin.cn)ã€‚
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2017/04/02/ç¼–ç¨‹åŸºç¡€/å¹¶è¡Œè®¡ç®—ç®€ä»‹/" class="pre-post btn btn-default" title='å¹¶è¡Œè®¡ç®—ç®€ä»‹'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">ä¸Šä¸€ç¯‡</span>
            <span class="hidden-xs">å¹¶è¡Œè®¡ç®—ç®€ä»‹</span>
        </a>
    
    
        <a href="/2016/09/30/ç¼–ç¨‹åŸºç¡€/ThriftäºŒè¿›åˆ¶åºåˆ—åŒ–TCompactProtocolä¸TBinaryProtocolçš„åŸç†å’ŒåŒºåˆ«/" class="next-post btn btn-default" title='ThriftäºŒè¿›åˆ¶åºåˆ—åŒ–TCompactProtocolä¸TBinaryProtocolçš„åŸç†å’ŒåŒºåˆ«'>
            <span class="hidden-lg">ä¸‹ä¸€ç¯‡</span>
            <span class="hidden-xs">ThriftäºŒè¿›åˆ¶åºåˆ—åŒ–TCompactProtocolä¸TBinaryProtocolçš„åŸç†å’ŒåŒºåˆ«</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
    
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'Wf244rKqAfDvqO3ID8IMPpHC-gzGzoHsz',
            appKey: 'a3FFMqGAk68xa9qyPfw0Cw6N',
            placeholder: 'å‘è¡¨è¯„è®º',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">æ–‡ç« ç›®å½•</h3>
        
            <p>æš‚æ— ç›®å½•</p>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<div class="copyright">
    <div class="container">
    

        Since<span>2015 | <span>ZhangXueMin</span> | <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span>æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>