<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="æ•°å¤§æ‹›ç–¯">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->





<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->


<title>è®©Spark Streamingåœ¨YARNä¸Šé•¿æ—¶é—´è¿è¡Œ | æ•°å¤§æ‹›ç–¯</title>


    <link rel="alternate" href="/atom.xml" title="æ•°å¤§æ‹›ç–¯" type="application/atom+xml">


    <link rel="icon" href="img/avatar.jpg">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

</head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">ä½ ä½¿ç”¨çš„æµè§ˆå™¨ç‰ˆæœ¬è¿‡ä½ï¼Œä¸ºäº†ä½ æ›´å¥½çš„é˜…è¯»ä½“éªŒï¼Œè¯·æ›´æ–°æµè§ˆå™¨çš„ç‰ˆæœ¬æˆ–è€…ä½¿ç”¨å…¶ä»–ç°ä»£æµè§ˆå™¨ï¼Œæ¯”å¦‚Chromeã€Firefoxã€Safariç­‰ã€‚</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1536170179765&amp;di=ab07d5f5a24a9d2bab9d1473a74e006c&amp;imgtype=0&amp;src=http%3A%2F%2Fpic.90sjimg.com%2Fback_pic%2F00%2F04%2F20%2F33%2F9e0ba3e5c577b49250f84a20a11f079c.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='XueMin Zhang'>
            <img src="/img/avatar.jpg" alt="logoå¤´åƒ" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippetä¸»é¢˜,ä»æœªå¦‚æ­¤ç®€å•æœ‰è¶£</h2>-->
            
                <h2> æ•°å¤§æ‹›ç–¯ </h2>
            
    	</div>
    </div>
</header>

    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">æ•°å¤§æ‹›ç–¯</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center" >
                                <a href="/"><i class="fa "></i>é¦–é¡µ </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/ç¼–ç¨‹åŸºç¡€/"><i class="fa "></i>ç¼–ç¨‹åŸºç¡€ </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/å¤§æ•°æ®/"><i class="fa "></i>å¤§æ•°æ® </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/æ•°æ®ç§‘å­¦"><i class="fa "></i>æ•°æ®ç§‘å­¦ </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/å›¾å­˜å‚¨ã€è®¡ç®—"><i class="fa "></i>å›¾å­˜å‚¨ã€è®¡ç®— </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/å·¥ç¨‹ã€å·¥å…·"><i class="fa "></i>å·¥ç¨‹ã€å·¥å…· </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/categories/"><i class="fa "></i>è¯»ä¹¦ </a>
                            </li>
                        
                            <li role="presentation" class="text-center" >
                                <a href="/archives/"><i class="fa "></i>æ—¶é—´è½´ </a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="è®©Spark Streamingåœ¨YARNä¸Šé•¿æ—¶é—´è¿è¡Œ">
            
	            è®©Spark Streamingåœ¨YARNä¸Šé•¿æ—¶é—´è¿è¡Œ
            
        </h1>
        <div class="post-meta">

    
    

    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/å¤§æ•°æ®">
            å¤§æ•°æ®
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/Spark" title='Spark'>
                        Spark
                    </a>
                
            
        </span>
    </span>
    


        <span>
         
         ğŸ•’ 2018å¹´05æœˆ16æ—¥
        </span>

       <span>
         <i class="fa fa-icon-user"></i>
          âœ ZhangXueMin
        </span>

    
        

        
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <p>å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„Spark Streamingä½œä¸šï¼Œä¸€æ—¦æäº¤åˆ°YARNç¾¤é›†ä¾¿éœ€è¦æ°¸ä¹…è¿è¡Œï¼Œç›´åˆ°æœ‰æ„åœæ­¢ã€‚ä»»ä½•ä¸­æ–­éƒ½ä¼šå¼•èµ·ä¸¥é‡çš„å¤„ç†å»¶è¿Ÿï¼Œå¹¶å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±æˆ–é‡å¤ã€‚YARNå’ŒApache Sparkéƒ½ä¸æ˜¯ä¸ºäº†æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡è€Œè®¾è®¡çš„ã€‚ä½†æ˜¯ï¼Œå®ƒä»¬å·²ç»æˆåŠŸåœ°æ»¡è¶³äº†è¿‘å®æ—¶æ•°æ®å¤„ç†ä½œä¸šçš„å¸¸é©»éœ€æ±‚ã€‚æˆåŠŸå¹¶ä¸ä¸€å®šæ„å‘³ç€æ²¡æœ‰æŠ€æœ¯æŒ‘æˆ˜ã€‚</p>
<p>è¿™ç¯‡åšå®¢æ€»ç»“äº†åœ¨å®‰å…¨çš„YARNé›†ç¾¤ä¸Šï¼Œè¿è¡Œä¸€ä¸ªå…³é”®ä»»åŠ¡ä¸”é•¿æ—¶é—´çš„Spark Streamingä½œä¸šçš„ç»éªŒã€‚æ‚¨å°†å­¦ä¹ å¦‚ä½•å°†Spark Streamingåº”ç”¨ç¨‹åºæäº¤åˆ°YARNç¾¤é›†ï¼Œä»¥é¿å…åœ¨å€¼ç­æ—¶å€™çš„ä¸çœ ä¹‹å¤œã€‚</p>
<h4 id="Fault-tolerance"><a href="#Fault-tolerance" class="headerlink" title="Fault tolerance"></a>Fault tolerance</h4><p>åœ¨YARNé›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒSparké©±åŠ¨ç¨‹åºä¸Application Masterï¼ˆåº”ç”¨ç¨‹åºåˆ†é…çš„ç¬¬ä¸€ä¸ªYARNå®¹å™¨ï¼‰åœ¨åŒä¸€å®¹å™¨ä¸­è¿è¡Œã€‚æ­¤è¿‡ç¨‹è´Ÿè´£ä»YARN é©±åŠ¨åº”ç”¨ç¨‹åºå’Œè¯·æ±‚èµ„æºï¼ˆSparkæ‰§è¡Œç¨‹åºï¼‰ã€‚é‡è¦çš„æ˜¯ï¼ŒApplication Masteræ¶ˆé™¤äº†åœ¨åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œçš„ä»»ä½•å…¶ä»–è¿›ç¨‹çš„éœ€è¦ã€‚å³ä½¿ä¸€ä¸ªæäº¤Spark Streamingä½œä¸šçš„è¾¹ç¼˜HadoopèŠ‚ç‚¹å¤±è´¥ï¼Œåº”ç”¨ç¨‹åºä¹Ÿä¸ä¼šå—åˆ°å½±å“ã€‚</p>
<p>è¦ä»¥é›†ç¾¤æ¨¡å¼è¿è¡ŒSpark Streamingåº”ç”¨ç¨‹åºï¼Œè¯·ç¡®ä¿ä¸ºspark-submitå‘½ä»¤æä¾›ä»¥ä¸‹å‚æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster</span><br></pre></td></tr></table></figure></p>
<p>ç”±äºSparké©±åŠ¨ç¨‹åºå’ŒApplication Masterå…±äº«ä¸€ä¸ªJVMï¼ŒSparké©±åŠ¨ç¨‹åºä¸­çš„ä»»ä½•é”™è¯¯éƒ½ä¼šé˜»æ­¢æˆ‘ä»¬é•¿æœŸè¿è¡Œçš„å·¥ä½œã€‚å¹¸è¿çš„æ˜¯ï¼Œå¯ä»¥é…ç½®é‡æ–°è¿è¡Œåº”ç”¨ç¨‹åºçš„æœ€å¤§å°è¯•æ¬¡æ•°ã€‚è®¾ç½®æ¯”é»˜è®¤å€¼2æ›´é«˜çš„å€¼æ˜¯åˆç†çš„ï¼ˆä»YARNé›†ç¾¤å±æ€§yarn.resourcemanager.am.maxå°è¯•ä¸­å¯¼å‡ºï¼‰ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œ4å·¥ä½œç›¸å½“å¥½ï¼Œå³ä½¿å¤±è´¥çš„åŸå› æ˜¯æ°¸ä¹…æ€§çš„ï¼Œè¾ƒé«˜çš„å€¼ä¹Ÿå¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡æ–°å¯åŠ¨ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœåº”ç”¨ç¨‹åºè¿è¡Œæ•°å¤©æˆ–æ•°å‘¨ï¼Œè€Œä¸é‡æ–°å¯åŠ¨æˆ–é‡æ–°éƒ¨ç½²åœ¨é«˜åº¦ä½¿ç”¨çš„ç¾¤é›†ä¸Šï¼Œåˆ™å¯èƒ½åœ¨å‡ ä¸ªå°æ—¶å†…è€—å°½4æ¬¡å°è¯•ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå°è¯•è®¡æ•°å™¨åº”è¯¥åœ¨æ¯ä¸ªå°æ—¶éƒ½é‡ç½®ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h</span><br></pre></td></tr></table></figure></p>
<p>å¦ä¸€ä¸ªé‡è¦çš„è®¾ç½®æ˜¯åœ¨åº”ç”¨ç¨‹åºå‘ç”Ÿæ•…éšœä¹‹å‰executorå¤±è´¥çš„æœ€å¤§æ•°é‡ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯maxï¼ˆ2 * num executorsï¼Œ3ï¼‰ï¼Œéå¸¸é€‚åˆæ‰¹å¤„ç†ä½œä¸šï¼Œä½†ä¸é€‚ç”¨äºé•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šã€‚è¯¥å±æ€§å…·æœ‰ç›¸åº”çš„æœ‰æ•ˆæœŸé—´ï¼Œä¹Ÿåº”è®¾ç½®ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h</span><br></pre></td></tr></table></figure></p>
<p>å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šï¼Œæ‚¨ä¹Ÿå¯ä»¥è€ƒè™‘åœ¨æ”¾å¼ƒä½œä¸šä¹‹å‰æé«˜ä»»åŠ¡å¤±è´¥çš„æœ€å¤§æ•°é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»åŠ¡å°†é‡è¯•4æ¬¡ï¼Œç„¶åä½œä¸šå¤±è´¥ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8</span><br><span class="line">Performance</span><br></pre></td></tr></table></figure></p>
<p>å½“Spark Streamingåº”ç”¨ç¨‹åºæäº¤åˆ°é›†ç¾¤æ—¶ï¼Œå¿…é¡»å®šä¹‰è¿è¡Œä½œä¸šçš„YARNé˜Ÿåˆ—ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä½¿ç”¨YARN Capacity Schedulerå¹¶å°†é•¿æ—¶é—´è¿è¡Œçš„ä½œä¸šæäº¤åˆ°å•ç‹¬çš„é˜Ÿåˆ—ã€‚æ²¡æœ‰ä¸€ä¸ªå•ç‹¬çš„YARNé˜Ÿåˆ—ï¼Œæ‚¨çš„é•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œè¿Ÿæ—©å°†è¢«çš„å¤§é‡HiveæŸ¥è¯¢æŠ¢å ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8  --queue realtime_queue</span><br></pre></td></tr></table></figure></p>
<p>Spark Streamingå·¥ä½œçš„å¦ä¸€ä¸ªé‡è¦é—®é¢˜æ˜¯ä¿æŒå¤„ç†æ—¶é—´çš„ç¨³å®šæ€§å’Œé«˜åº¦å¯é¢„æµ‹æ€§ã€‚å¤„ç†æ—¶é—´åº”ä¿æŒåœ¨æ‰¹æ¬¡æŒç»­æ—¶é—´ä»¥ä¸‹ä»¥é¿å…å»¶è¯¯ã€‚æˆ‘å‘ç°Sparkçš„æ¨æµ‹æ‰§è¡Œæœ‰å¾ˆå¤šå¸®åŠ©ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¹å¿™çš„ç¾¤é›†ä¸­ã€‚å½“å¯ç”¨æ¨æµ‹æ€§æ‰§è¡Œæ—¶ï¼Œæ‰¹å¤„ç†æ—¶é—´æ›´åŠ ç¨³å®šã€‚åªæœ‰å½“Sparkæ“ä½œæ˜¯å¹‚ç­‰æ—¶ï¼Œæ‰èƒ½å¯ç”¨æ¨æµ‹æ¨¡å¼ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8  --queue realtime_queue --conf spark.speculation=true</span><br></pre></td></tr></table></figure></p>
<h4 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h4><p>åœ¨å®‰å…¨çš„HDFSç¾¤é›†ä¸Šï¼Œé•¿æ—¶é—´è¿è¡Œçš„Spark Streamingä½œä¸šç”±äºKerberosç¥¨æ®åˆ°æœŸè€Œå¤±è´¥ã€‚æ²¡æœ‰å…¶ä»–è®¾ç½®ï¼Œå½“Spark Streamingä½œä¸šæäº¤åˆ°é›†ç¾¤æ—¶ï¼Œä¼šå‘å¸ƒKerberosç¥¨è¯ã€‚å½“ç¥¨è¯åˆ°æœŸæ—¶Spark Streamingä½œä¸šä¸èƒ½å†ä»HDFSå†™å…¥æˆ–è¯»å–æ•°æ®ã€‚</p>
<p>åœ¨ç†è®ºä¸Šï¼ˆåŸºäºæ–‡æ¡£ï¼‰ï¼Œåº”è¯¥å°†Kerberosä¸»ä½“å’Œkeytabä½œä¸ºspark-submitå‘½ä»¤ä¼ é€’ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8  --queue realtime_queue --conf spark.speculation=true  --principal user/hostname@domain --keytab /path/to/foo.keytab</span><br></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šï¼Œç”±äºå‡ ä¸ªé”™è¯¯ï¼ˆHDFS-9276, SPARK-11182ï¼‰å¿…é¡»ç¦ç”¨HDFSç¼“å­˜ã€‚å¦‚æœæ²¡æœ‰ï¼ŒSparkå°†æ— æ³•ä»HDFSä¸Šçš„æ–‡ä»¶è¯»å–æ›´æ–°çš„ä»¤ç‰Œã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8  --queue realtime_queue --conf spark.speculation=true  --principal user/hostname@domain --keytab /path/to/foo.keytab --conf spark.hadoop.fs.hdfs.impl.disable.cache=true</span><br></pre></td></tr></table></figure></p>
<p>Mark GroveræŒ‡å‡ºï¼Œè¿™äº›é”™è¯¯åªå½±å“åœ¨HAæ¨¡å¼ä¸‹é…ç½®äº†NameNodesçš„HDFSé›†ç¾¤ã€‚è°¢è°¢ï¼ŒMarkã€‚</p>
<h4 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h4><p>è®¿é—®Sparkåº”ç”¨ç¨‹åºæ—¥å¿—çš„æœ€ç®€å•æ–¹æ³•æ˜¯é…ç½®Log4jæ§åˆ¶å°è¿½åŠ ç¨‹åºï¼Œç­‰å¾…åº”ç”¨ç¨‹åºç»ˆæ­¢å¹¶ä½¿ç”¨yarn logs -applicationId [applicationId]å‘½ä»¤ã€‚ä¸å¹¸çš„æ˜¯ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„Spark Streamingä½œä¸šæ¥è®¿é—®æ—¥å¿—æ˜¯ä¸å¯è¡Œçš„ã€‚</p>
<p>æˆ‘å»ºè®®å®‰è£…å’Œé…ç½®Elasticï¼ŒLogstashå’ŒKibanaï¼ˆELKå¥—è£…ï¼‰ã€‚ELKçš„å®‰è£…å’Œé…ç½®æ˜¯è¶…å‡ºäº†è¿™ç¯‡åšå®¢çš„èŒƒå›´ï¼Œä½†è¯·è®°ä½è®°å½•ä»¥ä¸‹ä¸Šä¸‹æ–‡å­—æ®µï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">YARN application id</span><br><span class="line">YARN container hostname</span><br><span class="line">Executor id (Spark driver is always 000001, Spark executors start from 000002)</span><br><span class="line">YARN attempt (to check how many times Spark driver has been restarted)</span><br></pre></td></tr></table></figure></p>
<p>Log4jé…ç½®ä½¿ç”¨Logstashç‰¹å®šçš„appenderå’Œå¸ƒå±€å®šä¹‰åº”è¯¥ä¼ é€’ç»™spark-submitå‘½ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spark-submit --master yarn --deploy-mode cluster --conf spark.yarn.maxAppAttempts=4  --conf spark.yarn.am.attemptFailuresValidityInterval=1h --conf spark.yarn.max.executor.failures=&#123;8 * num_executors&#125; --conf spark.yarn.executor.failuresValidityInterval=1h --conf spark.task.maxFailures=8  --queue realtime_queue --conf spark.speculation=true  --principal user/hostname@domain --keytab /path/to/foo.keytab --conf spark.hadoop.fs.hdfs.impl.disable.cache=true  --conf spark.driver.extraJavaOptions=-Dlog4j.configuration=file:log4j.properties --conf spark.executor.extraJavaOptions=-Dlog4j.configuration=file:log4j.properties --files /path/to/log4j.properties</span><br></pre></td></tr></table></figure></p>
<p>æœ€åï¼ŒSpark Jobçš„Kibanaä»ªè¡¨æ¿å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<h4 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h4><p>é•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œå…¨å¤©å€™è¿è¡Œï¼Œæ‰€ä»¥äº†è§£å†å²æŒ‡æ ‡å¾ˆé‡è¦ã€‚Spark UIä»…åœ¨æœ‰é™æ•°é‡çš„æ‰¹æ¬¡ä¸­ä¿ç•™ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨é‡æ–°å¯åŠ¨åï¼Œæ‰€æœ‰åº¦é‡æ ‡å‡†éƒ½æ¶ˆå¤±äº†ã€‚å†æ¬¡ï¼Œéœ€è¦å¤–éƒ¨å·¥å…·ã€‚æˆ‘å»ºè®®å®‰è£…Graphiteç”¨äºæ”¶é›†æŒ‡æ ‡å’ŒGrafanaæ¥å»ºç«‹ä»ªè¡¨æ¿ã€‚</p>
<p>é¦–å…ˆï¼ŒSparkéœ€è¦é…ç½®ä¸ºå°†æŒ‡æ ‡æŠ¥å‘Šç»™Graphiteï¼Œå‡†å¤‡metrics.propertiesæ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*.sink.graphite.class=org.apache.spark.metrics.sink.GraphiteSink</span><br><span class="line">*.sink.graphite.host=[hostname]</span><br><span class="line">*.sink.graphite.port=[port] *.sink.graphite.prefix=some_meaningful_name</span><br><span class="line"></span><br><span class="line">driver.source.jvm.class=org.apache.spark.metrics.source.JvmSource</span><br><span class="line">executor.source.jvm.class=org.apache.spark.metrics.source.JvmSource</span><br></pre></td></tr></table></figure></p>
<h4 id="Graceful-stop"><a href="#Graceful-stop" class="headerlink" title="Graceful stop"></a>Graceful stop</h4><p>æœ€åä¸€ä¸ªéš¾é¢˜æ˜¯å¦‚ä½•ä»¥ä¼˜é›…çš„æ–¹å¼åœæ­¢éƒ¨ç½²åœ¨YARNä¸Šçš„Spark Streamingåº”ç”¨ç¨‹åºã€‚åœæ­¢ï¼ˆç”šè‡³æ€æ­»ï¼‰YARNåº”ç”¨ç¨‹åºçš„æ ‡å‡†æ–¹æ³•æ˜¯ä½¿ç”¨å‘½ä»¤yarn application -kill [applicationId]ã€‚è¿™ä¸ªå‘½ä»¤ä¼šåœæ­¢Spark Streamingåº”ç”¨ç¨‹åºï¼Œä½†è¿™å¯èƒ½å‘ç”Ÿåœ¨æ‰¹å¤„ç†ä¸­ã€‚å› æ­¤ï¼Œå¦‚æœè¯¥ä½œä¸šæ˜¯ä»Kafkaè¯»å–æ•°æ®ç„¶ååœ¨HDFSä¸Šä¿å­˜å¤„ç†ç»“æœï¼Œå¹¶æœ€ç»ˆæäº¤Kafkaåç§»é‡ï¼Œå½“ä½œä¸šåœ¨æäº¤åç§»ä¹‹å‰åœæ­¢å·¥ä½œæ—¶ï¼Œæ‚¨åº”è¯¥é¢„è§åˆ°HDFSä¼šæœ‰é‡å¤çš„æ•°æ®ã€‚</p>
<p>è§£å†³ä¼˜é›…å…³æœºé—®é¢˜çš„ç¬¬ä¸€ä¸ªå°è¯•æ˜¯åœ¨å…³é—­ç¨‹åºæ—¶å›è°ƒSpark Streaming Contextçš„åœæ­¢æ–¹æ³•ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sys.addShutdownHook &#123;</span><br><span class="line">    streamingContext.stop(stopSparkContext = true, stopGracefully = true)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»¤äººå¤±æœ›çš„æ˜¯ï¼Œç”±äºSparkåº”ç”¨ç¨‹åºå‡ ä¹ç«‹å³è¢«æ€æ­»ï¼Œä¸€ä¸ªé€€å‡ºå›è°ƒå‡½æ•°æ¥ä¸åŠå®Œæˆå·²å¯åŠ¨çš„æ‰¹å¤„ç†ä»»åŠ¡ã€‚æ­¤å¤–ï¼Œä¸èƒ½ä¿è¯JVMä¼šè°ƒç”¨shutdown hookã€‚</p>
<p>åœ¨æ’°å†™æœ¬åšå®¢æ–‡ç« æ—¶ï¼Œå”¯ä¸€ç¡®è®¤çš„YARN Spark Streamingåº”ç”¨ç¨‹åºçš„ç¡®åˆ‡æ–¹æ³•æ˜¯é€šçŸ¥åº”ç”¨ç¨‹åºå…³äºè®¡åˆ’å…³é—­ï¼Œç„¶åä»¥ç¼–ç¨‹æ–¹å¼åœæ­¢æµå¼ä¼ è¾“ï¼ˆä½†ä¸æ˜¯å…³é—­æŒ‚é’©ï¼‰ã€‚å‘½ä»¤yarn application -kill å¦‚æœé€šçŸ¥åº”ç”¨ç¨‹åºåœ¨å®šä¹‰çš„è¶…æ—¶åæ²¡æœ‰åœæ­¢ï¼Œåˆ™åº”è¯¥ä»…ç”¨ä½œæœ€åæ‰‹æ®µã€‚</p>
<p>å¯ä»¥ä½¿ç”¨HDFSä¸Šçš„æ ‡è®°æ–‡ä»¶ï¼ˆæœ€ç®€å•çš„æ–¹æ³•ï¼‰æˆ–ä½¿ç”¨é©±åŠ¨ç¨‹åºä¸Šå…¬å¼€çš„ç®€å•Socket / HTTPç«¯ç‚¹ï¼ˆå¤æ‚æ–¹å¼ï¼‰é€šçŸ¥åº”ç”¨ç¨‹åºã€‚</p>
<p>å› ä¸ºæˆ‘å–œæ¬¢KISSåŸç†ï¼Œä¸‹é¢ä½ å¯ä»¥æ‰¾åˆ°shellè„šæœ¬ä¼ªä»£ç ï¼Œç”¨äºå¯åŠ¨/åœæ­¢Spark Streamingåº”ç”¨ç¨‹åºä½¿ç”¨æ ‡è®°æ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start() &#123;</span><br><span class="line">    hdfs dfs -touchz /path/to/marker/my_job_unique_name</span><br><span class="line">    spark-submit ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stop() &#123;</span><br><span class="line">    hdfs dfs -rm /path/to/marker/my_job_unique_name</span><br><span class="line">    force_kill=true application_id=$(yarn application -list | grep -oe &quot;application_[0-9]*_[0-9]*&quot;`) for i in `seq 1 10`; do application_status=$(yarn application -status $&#123;application_id&#125; | grep &quot;State : \(RUNNING\|ACCEPTED\)&quot;) if [ -n &quot;$application_status&quot; ]; then</span><br><span class="line">            sleep 60s else force_kill=false</span><br><span class="line">            break fi</span><br><span class="line">    done</span><br><span class="line">    $force_kill &amp;&amp; yarn application -kill $&#123;application_id&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨Spark Streamingåº”ç”¨ç¨‹åºä¸­ï¼Œåå°çº¿ç¨‹åº”è¯¥ç›‘è§†æ ‡è®°æ–‡ä»¶ï¼Œå½“æ–‡ä»¶æ¶ˆå¤±æ—¶åœæ­¢ä¸Šä¸‹æ–‡è°ƒç”¨<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">streamingContext.stop(stopSparkContext = true, stopGracefully = true)</span><br></pre></td></tr></table></figure></p>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>å¯ä»¥çœ‹åˆ°ï¼Œéƒ¨ç½²åœ¨YARNä¸Šçš„å…³é”®ä»»åŠ¡Spark Streamingåº”ç”¨ç¨‹åºçš„é…ç½®ç›¸å½“å¤æ‚ã€‚ä»¥ä¸Šæå‡ºçš„æŠ€æœ¯ï¼Œç”±ä¸€äº›éå¸¸èªæ˜çš„å¼€å‘äººå‘˜ç»è¿‡æ¼«é•¿è€Œå†—é•¿ä¹å‘³çš„è¿­ä»£å­¦ä¹ ã€‚æœ€ç»ˆï¼Œéƒ¨ç½²åœ¨é«˜å¯ç”¨çš„YARNé›†ç¾¤ä¸Šçš„é•¿æœŸè¿è¡Œçš„Spark Streamingåº”ç”¨éå¸¸ç¨³å®šã€‚</p>
<p>ç¿»è¯‘ï¼š<a href="http://mkuthan.github.io/blog/2016/09/30/spark-streaming-on-yarn/" target="_blank" rel="noopener">http://mkuthan.github.io/blog/2016/09/30/spark-streaming-on-yarn/</a></p>

    </div>

    <div class="post-footer">
        <div>
            
                å£°æ˜ï¼šæ¬¢è¿è½¬è½½ã€é‡æ–°å‘å¸ƒã€‚å¦‚ç”¨äºå•†ä¸šç›®çš„ï¼Œè¯·<a href="mailto:xuemin.zhang@foxmail.com" target="_blank">è”ç³»ä½œè€…</a>è·å¾—æˆæƒã€‚éå•†ä¸šç›®çš„ï¼Œè¯·åŠ¡å¿…ä¿ç•™æ–‡ç« ä½œè€…ç½²å(<a href="https://zhangxuemin.cn" target="_blank">å¼ å­¦æ•</a>)åŠé“¾æ¥(https://zhangxuemin.cn)ã€‚
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
    
        <a href="/2018/04/29/å¤§æ•°æ®/Spark/å¼€å¯Back Pressureä½¿ç”Ÿäº§ç¯å¢ƒçš„Spark Streamingåº”ç”¨æ›´ç¨³å®šã€æœ‰æ•ˆ/" class="next-post btn btn-default" title='å¼€å¯Back Pressureä½¿ç”Ÿäº§ç¯å¢ƒçš„Spark Streamingåº”ç”¨æ›´ç¨³å®šã€æœ‰æ•ˆ'>
            <span class="hidden-lg">ä¸‹ä¸€ç¯‡</span>
            <span class="hidden-xs">å¼€å¯Back Pressureä½¿ç”Ÿäº§ç¯å¢ƒçš„Spark Streamingåº”ç”¨æ›´ç¨³å®šã€æœ‰æ•ˆ</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
    
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: 'Wf244rKqAfDvqO3ID8IMPpHC-gzGzoHsz',
            appKey: 'a3FFMqGAk68xa9qyPfw0Cw6N',
            placeholder: 'å‘è¡¨è¯„è®º',
            notify: false,
            verify: false,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">æ–‡ç« ç›®å½•</h3>
        
            <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fault-tolerance"><span class="toc-text">Fault tolerance</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Security"><span class="toc-text">Security</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Logging"><span class="toc-text">Logging</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Monitoring"><span class="toc-text">Monitoring</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Graceful-stop"><span class="toc-text">Graceful stop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Summary"><span class="toc-text">Summary</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<div class="copyright">
    <div class="container">
    

        Since<span>2015 | <span>ZhangXueMin</span> | <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span>æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>